package xyz.dreature.smct.controller.base;

import cn.hutool.core.convert.Convert;
import cn.hutool.core.text.StrSplitter;
import cn.hutool.core.util.ArrayUtil;
import cn.hutool.core.util.TypeUtil;
import io.swagger.v3.oas.annotations.Operation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import xyz.dreature.smct.common.vo.Result;
import xyz.dreature.smct.service.BaseService;

import javax.validation.Valid;
import javax.validation.constraints.*;
import java.io.Serializable;
import java.util.List;
import java.util.Map;

@Slf4j
@Validated
public abstract class BaseController<T, ID extends Serializable, S extends BaseService<T, ID, ?>> {
    protected final S service;
    protected final Class<T> entityClass;
    protected final Class<ID> idClass;

    public BaseController(S service) {
        this.service = service;
        this.entityClass = (Class<T>) TypeUtil.getTypeArgument(this.getClass(), 0);
        this.idClass = (Class<ID>) TypeUtil.getTypeArgument(this.getClass(), 1);
    }

    // ===== 查询基础操作 =====
    @Operation(summary = "查询总数")
    @GetMapping("/count-all")
    public ResponseEntity<Result<Integer>> countAll() {
        int count = service.countAll();
        String message = String.format("查询总数为 %d 条", count);
        log.info("查询总数完成，条数：{}", count);
        return ResponseEntity.ok().body(Result.success(message, count));
    }

    @Operation(summary = "查询全部")
    @GetMapping("/select-all")
    public ResponseEntity<Result<List<T>>> selectAll() {
        List<T> result = service.selectAll();
        int resultCount = result.size();
        String message = String.format("全表查询 %d 条数据", resultCount);
        log.info("全表查询完成，条数：{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    @Operation(summary = "查询随机")
    @GetMapping("/select-random")
    public ResponseEntity<Result<List<T>>> selectRandom(
            @RequestParam(name = "limit", defaultValue = "10")
            @Positive(message = "条数必须为正")
            int limit
    ) {
        List<T> result = service.selectRandom(limit);
        int resultCount = result.size();
        String message = String.format("随机查询 %d 条数据", resultCount);
        log.info("随机查询完成，条数：{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    @Operation(summary = "查询页面")
    @GetMapping("/select-by-page")
    public ResponseEntity<Result<List<T>>> selectByPage(
            @RequestParam(name = "offset", defaultValue = "0")
            @Min(value = 0, message = "偏移量不能为负")
            int offset,

            @RequestParam(name = "limit")
            @Min(value = 0, message = "限数不能为负")
            int limit
    ) {
        List<T> result = service.selectByPage(offset, limit);
        int resultCount = result.size();
        String message = String.format("页面查询 %d 条数据", resultCount);
        log.info("页面查询完成，条数:{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    @Operation(summary = "条件查询")
    @PostMapping("/select-by-condition")
    public ResponseEntity<Result<List<T>>> selectByCondition(
            @RequestBody
            @NotEmpty(message = "查询条件不能为空")
            Map<String, Object> condition
    ) {
        List<T> result = service.selectByCondition(condition);
        int resultCount = result.size();
        String message = String.format("条件查询 %d 条数据", resultCount);
        log.info("条件查询完成，条数：{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    @Operation(summary = "逐项查询")
    @GetMapping("/select-by-ids")
    public ResponseEntity<Result<List<T>>> selectByIds(
            @RequestParam(name = "ids")
            @NotBlank(message = "ID 不能为空")
            @Pattern(regexp = "^\\d+(,\\d+)*$", message = "ID 需由逗号分隔")
            String ids
    ) {
        List<ID> idList = Convert.toList(idClass, StrSplitter.split(ids, ',', 0, true, false));

        List<T> result = service.selectByIds(idList);
        int resultCount = result.size();
        String message = String.format("逐项查询 %d 条数据", resultCount);
        log.info("逐项查询完成，条数：{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    @Operation(summary = "分批查询")
    @GetMapping("/select-batch-by-ids")
    public ResponseEntity<Result<List<T>>> selectBatchByIds(
            @RequestParam(name = "ids")
            @NotBlank(message = "ID 不能为空")
            @Pattern(regexp = "^\\d+(,\\d+)*$", message = "ID 需由逗号分隔")
            String ids,

            @RequestParam(name = "batch-size", defaultValue = "1000")
            @Positive(message = "批大小必须为正")
            int batchSize
    ) {
        List<ID> idList = Convert.toList(idClass, StrSplitter.split(ids, ',', 0, true, false));

        List<T> result = service.selectBatchByIds(idList, batchSize);
        int resultCount = result.size();
        String message = String.format("分批查询 %d 条数据", resultCount);
        log.info("分批查询完成，条数：{}", resultCount);
        return ResponseEntity.ok().body(Result.success(message, result));
    }

    // ===== 插入基础操作 =====
    @Operation(summary = "逐项插入")
    @PostMapping("/insert")
    public ResponseEntity<Result<Void>> insert(
            @RequestBody
            @NotEmpty(message = "插入的数据不能为空")
            @Valid
            T[] entities
    ) {
        int affectedRows = service.insert(entities);
        String message = String.format("逐项插入 %d 条数据", affectedRows);
        log.info("逐项插入完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    @Operation(summary = "分批插入")
    @PostMapping("/insert-batch")
    public ResponseEntity<Result<Void>> insertBatch(
            @RequestBody
            @NotEmpty(message = "插入的数据不能为空")
            @Valid
            List<T> entities,

            @RequestParam(name = "batch-size", defaultValue = "1000")
            @Positive(message = "批大小必须为正")
            int batchSize
    ) {
        int affectedRows = service.insertBatch(entities, batchSize);
        String message = String.format("分批插入 %d 条数据", affectedRows);
        log.info("分批插入完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    // ===== 更新基础操作 =====
    @Operation(summary = "逐项更新")
    @PostMapping("/update")
    public ResponseEntity<Result<Void>> update(
            @RequestBody
            @NotEmpty(message = "更新的数据不能为空")
            @Valid
            T[] entities
    ) {
        int affectedRows = service.update(entities);
        String message = String.format("逐项更新 %d 条数据", affectedRows);
        log.info("逐项更新完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    @Operation(summary = "分批更新")
    @PostMapping("/update-batch")
    public ResponseEntity<Result<Void>> updateBatch(
            @RequestBody
            @NotEmpty(message = "更新的数据不能为空")
            @Valid
            List<T> entities,

            @RequestParam(name = "batch-size", defaultValue = "1000")
            @Positive(message = "批大小必须为正")
            int batchSize
    ) {
        int affectedRows = service.updateBatch(entities, batchSize);
        String message = String.format("分批更新 %d 条数据", affectedRows);
        log.info("分批更新完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    // ===== 插入或更新基础操作 =====
    @Operation(summary = "逐项插入或更新")
    @PostMapping("/upsert")
    public ResponseEntity<Result<Void>> upsert(
            @RequestBody
            @NotEmpty(message = "插入或更新的数据不能为空")
            @Valid
            List<T> entities
    ) {
        T[] entityArray = ArrayUtil.toArray(entities, entityClass);

        int affectedRows = service.upsert(entityArray);
        String message = String.format("逐项插入或更新 %d 条数据", affectedRows);
        log.info("逐项插入或更新完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    @Operation(summary = "分批插入或更新")
    @PostMapping("/upsert-batch")
    public ResponseEntity<Result<Void>> upsertBatch(
            @RequestBody
            @NotEmpty(message = "插入或更新的数据不能为空")
            @Valid
            List<T> entities,

            @RequestParam(name = "batch-size", defaultValue = "1000")
            @Positive(message = "批大小必须为正")
            int batchSize
    ) {
        int affectedRows = service.upsertBatch(entities, batchSize);
        String message = String.format("分批插入或更新 %d 条数据", affectedRows);
        log.info("分批插入或更新完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    // ===== 删除基础操作 =====
    @Operation(summary = "逐项删除")
    @PostMapping("/delete-by-ids")
    public ResponseEntity<Result<Void>> deleteById(
            @RequestParam(name = "ids")
            @NotBlank(message = "ID 不能为空")
            @Pattern(regexp = "^\\d+(,\\d+)*$", message = "ID 需由逗号分隔")
            String ids
    ) {
        List<ID> idList = Convert.toList(idClass, StrSplitter.split(ids, ',', 0, true, false));

        int affectedRows = service.deleteByIds(idList);
        String message = String.format("逐项删除 %d 条数据", affectedRows);
        log.info("逐项删除完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    @Operation(summary = "分批删除")
    @PostMapping("/delete-batch-by-ids")
    public ResponseEntity<Result<Void>> deleteBatchByIds(
            @RequestParam(name = "ids")
            @NotBlank(message = "ID 不能为空")
            @Pattern(regexp = "^\\d+(,\\d+)*$", message = "ID 需由逗号分隔")
            String ids,

            @RequestParam(name = "batch-size", defaultValue = "1000")
            @Positive(message = "批大小必须为正")
            int batchSize
    ) {
        List<ID> idList = Convert.toList(idClass, StrSplitter.split(ids, ',', 0, true, false));

        int affectedRows = service.deleteBatchByIds(idList, batchSize);
        String message = String.format("分批删除 %d 条数据", affectedRows);
        log.info("分批删除完成，影响行数：{}", affectedRows);
        return ResponseEntity.ok().body(Result.success(message, null));
    }

    // ===== 其他操作 =====
    @Operation(summary = "清空")
    @PostMapping("/truncate")
    public ResponseEntity<Result<Void>> truncate() {
        int count = service.countAll();
        service.truncate();
        String message = String.format("清空 %d 条数据", count);
        log.info("清空完成，条数：{}", count);
        return ResponseEntity.ok().body(Result.success(message, null));
    }
}
